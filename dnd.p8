pico-8 cartridge // http://www.pico-8.com
version 41
__lua__

debug = {}
#include door.lua
local GRID_SIZE = 8
player = {
    spr = 1,
    spr2 = 3,
    x = 50,
    y = 64,
    top = 1,
    bot = 7,
    left = 2,
    right = 5,
    speed = 1
}

base_npc = {
    name = "default",
    spr = 0,
    x = 64,
    y = 64,
    top = -7,
    bot = 15,
    left = -7,
    right = 15,
    curr_map = 0
}

-- This function creates a new NPC based on the base NPC and an overrides table
function create_npc(overrides)
    -- Create a new table by copying the base_npc
    local npc = {}
    for k, v in pairs(base_npc) do
        npc[k] = v
    end

    -- Apply the overrides
    for k, v in pairs(overrides) do
        npc[k] = v
    end

    return npc
end
npcs = {
    create_npc({ name = "rowan", x = 50, y = 40, spr = 24, curr_map = 1 }),
    create_npc({ name = "fintan", x = 40, y = 50, spr = 40, curr_map = 2 }),
    create_npc({ name = "saksham", x = 80, y = 80, spr = 56, curr_map = 2 }),
    create_npc({ name = "robie", x = 72, y = 72, spr = 8, curr_map = 3 })
}

-- define menu options
menu = { "tALK", "sEARCH", "iTEM", "sPELL", "eQUIP" }
menu_index = 1 -- Start the menu with the first item selected

#include dialogues.lua

map_music = {
    group1 = {
        maps = { 1, 2 }, -- Maps that share the same music
        start = 0,
        stop = 4
    },
    group2 = {
        maps = { 3 },
        start = 5,
        stop = 7
    }
    -- ... Add other mappings as you expand your game
}

maps = {
    {
        id = 1,
        name = "rowans_house",
        cell_x = 0,
        cell_y = 0,
        non_walkable = { 96, 97, 112, 113 }
    },
    {
        id = 2,
        name = "cavea_lieter",
        cell_x = 17, -- example, starting from cell 16 on the x-axis
        cell_y = 0,
        non_walkable = { 96, 97, 112, 113, 64, 65, 80, 81 }
    },
    {
        id = 3,
        name = "north_basement",
        cell_x = 33,
        cell_y = 0,
        non_walkable = { 66, 67, 82, 83, 102, 103, 118, 119 }
    }
    -- ... other maps ...
}
active_map = maps[1].id -- Start the game in the first map
current_room_x = 0
current_room_y = 0
curr_map = 0

PROC_GEN_MAP_ID = 100
WATER_SPRITE = 114
LAND_SPRITE = 115
MOUNTAIN_SPRITE = 116
proc_gen_map_width = 64
proc_gen_map_height = 64
proc_gen_world_map = {}
proc_gen_non_walkable = {114,116}


gamestate = "game" -- Start the game in the game state
pxl_mvmt_on = false



#include update.lua
#include draw.lua
#include perlin.lua
#include util.lua

function populate_world()
    for y=1, proc_gen_map_height do
        for x=1, proc_gen_map_width do
            local value = heightmap[x][y]

            if value <= 2 then
                proc_gen_world_map[y][x] = WATER_SPRITE  -- water sprite
            elseif value < 6 then
                proc_gen_world_map[y][x] = LAND_SPRITE  -- land sprite
            else
                proc_gen_world_map[y][x] = MOUNTAIN_SPRITE  -- mountain sprite
            end
        end
    end
end

function init_proc_gen_map()
    for y=1, proc_gen_map_height do
        proc_gen_world_map[y] = {}
        for x=1, proc_gen_map_width do
            proc_gen_world_map[y][x] = 0
        end
    end
    points = random_points()
    smoothed = smooth_points(points)
    heightmap = to_heightmap(smoothed)
    populate_world()
end

function _init()
    play_music_for_map(active_map)

    init_proc_gen_map()    
end
__gfx__
0067770006222200062222000622220006222200000000000000000000ccccc04433334444333344000000000000000000000000000000000000000000000000
00677700062ff200062ff200062ff200062ff200000000000000000000ccccc04453534444353544000000000000000000000000000000000000000000000000
0067770006222200062222000622220006222200000000000000000000555cc04433334444333344000000000000000000000000000000000000000000000000
0567777006022686060226860602268606022286000000000000000000ccccc04443344444433444000000000000000000000000000000000000000000000000
0567776066622888662228886662288866622288000000000000000000cccbc04433334444333344000000000000000000000000000000000000000000000000
0557765006222686062226860622268606222286000000000000000000ccc4c04433334444333344000000000000000000000000000000000000000000000000
005666000622226006222260062222600622226000000000000000000cccc4c04433334444333344000000000000000000000000000000000000000000000000
0055550000dddd0000222200002222000022220000000000000000000dddddd04433334444333344000000000000000000000000000000000000000000000000
000000000022220000222200002222000622220000000000000000000ccccc0044aaaa4444aaaa44441111440000000000000000000000000000000000000000
000000000022220000222200002222000622220000000000000000000ccccc00447f7a4444a7f744441111440000000000000000000000000000000000000000
0000000000ff220000ff220000ff220006ff220000000000000000000cc5550044affa4444affa44441111440000000000000000000000000000000000000000
000000000028620008622200002862000622860000000000000000000ccccc0044aeea4444aeea44444114440000000000000000000000000000000000000000
000000000028820008822200002882006622880000000000000000000cbccc00444ee444444ee444441111440000000000000000000000000000000000000000
000000000028620008622200002862000622860000000000000000000c4ccc0044eeee4444eeee44441111440000000000000000000000000000000000000000
000000000026220006222200002622000622620000000000000000000c4cccc044eeee4444eeee44441111440000000000000000000000000000000000000000
0000000000dddd0000dddd0000dddd0000dddd0000000000000000000dddddd044eeee4444eeee44441111440000000000000000000000000000000000000000
000000000022620000262200002262000022226000000000000000000555550044aaaa4444aaaa44000000000000000000000000000000000000000000000000
0000000000226200002622000022620000222260000000000000000006161600447f7f4444f7f744000000000000000000000000000000000000000000000000
0000000000226f000026ff0000226f000022ff6000000000000000000555550044ffff4444ffff44000000000000000000000000000000000000000000000000
00000000002262000026226800226200002222600000000000000000005550004441144444411444000000000000000000000000000000000000000000000000
00000000002666000066628800266600002226660000000000000000005550004411114444111144000000000000000000000000000000000000000000000000
00000000002262000026226800226200002222600000000000000000005550004411114444111144000000000000000000000000000000000000000000000000
00000000002262000026220600226200002222600000000000000000005550004411114444111144000000000000000000000000000000000000000000000000
0000000000dddd0000dddd0000dddd0000dddd000000000000000000055555004411114444111144000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000005555504444444444444444000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000006161604444444444444444000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000005555504444444444444444000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000555004479794444979744000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000555004499994444999944000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000555004449944444499444000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000555004449944444499444000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000005555504449944444499444000000000000000000000000000000000000000000000000
55555555555555555555555666555555444444444444444444444444511111154455555555555544044444440000000000000000000000000000000000000000
55566655555555555555556666665555444444444444454444455444511111154557777777777554404444400000000000000000000000000000000000000000
55666666555665555555566666666655444444444444554444444445511111155577777777777755440444040000000000000000000000000000000000000000
56666666656666655555666666666655444444444444444444444444511111155777777777777775444040440000000000000000000000000000000000000000
56666666656666655556666666666665444444444444444444444444511111655777777777777775444404440000000000000000000000000000000000000000
56666666656666655566666666666666444444445444444444554444511111155777777777777775444440440000000000000000000000000000000000000000
56666666656565655566666666666666444444444445544444544444511111155777777777777775444444040000000000000000000000000000000000000000
56665656555656555666666666666666444444444444444444444444511111155777777777777775444444400000000000000000000000000000000000000000
56666565656565655666666666666666000000000000000000000000000000004455554466666666666666660000000000000000000000000000000000000000
55565656555555555666666666666665000000000000000000000000000000004557755467777776666666660000000000000000000000000000000000000000
55555565555665555566666666666565000000000000000000000000000000005577775567777776666666660000000000000000000000000000000000000000
55565555566666655566666666665655000000000000000000000000000000005777777569999996666666660000000000000000000000000000000000000000
55665555665656655666666565656565000000000000000000000000000000005777777567977976666666660000000000000000000000000000000000000000
55656555666565655566665656565655000000000000000000000000000000005777777567999976666666660000000000000000000000000000000000000000
55565655565656555666656565656565000000000000000000000000000000005777777567777776666666660000000000000000000000000000000000000000
55555555555555555666565656565655000000000000000000000000000000005777777566666666666666660000000000000000000000000000000000000000
05556555666665555506066655555555000000006655555555555544454555555555555600000000000000000000000000000000000000000000000000000000
00666666666666550666665655566555000000006666666655555445445555566665556600000000000000000000000000000000000000000000000000000000
06666666666666665666666655665655000000006666665666555554455555666566666600000000000000000000000000000000000000000000000000000000
05666666666666660666666666656565000000006666666566555544445556666666666600000000000000000000000000000000000000000000000000000000
06666666666666665666666666665666000000006666666660655554455556666666666600000000000000000000000000000000000000000000000000000000
00666665566666660566666665656565000000006666666666555555455566666666666600000000000000000000000000000000000000000000000000000000
05555665666666660666665655555656000000006666666666655554455566666666666600000000000000000000000000000000000000000000000000000000
00666556666666655565655555555555000000006666666656565554555666666666666600000000000000000000000000000000000000000000000000000000
0666666566666666ccccccccbbbbbbbb555555556666666666655554455666666666666600000000000000000000000000000000000000000000000000000000
0566666656666666ccccccccbbbbbbbb555555556666666656565555556666666666666600000000000000000000000000000000000000000000000000000000
0666666666666666ccccccccbbbbbbbb555555556666656666656555456666666666666600000000000000000000000000000000000000000000000000000000
0556566666666666ccccccccbbbbbbbb555555556666565656565555556666666666666600000000000000000000000000000000000000000000000000000000
0665666665656666ccccccccbbbbbbbb555555556565656565656555556666666666666500000000000000000000000000000000000000000000000000000000
0566666666566666ccccccccbbbbbbbb555555555656565656565655556666566666665600000000000000000000000000000000000000000000000000000000
0656660666606655ccccccccbbbbbbbb555555556565656565656555566665666666656500000000000000000000000000000000000000000000000000000000
0000505050505555ccccccccbbbbbbbb555555555656565656565655566656566666565600000000000000000000000000000000000000000000000000000000
__map__
4444444444444444444444444444444400404140414063404140414041404140414400000000000044000000000000004400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4400000000000000000000000000004400505150515000505150515051505150514400000000000000000000000000004400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4400006061606160616061606100004400404144444444446061626061444440414400004243424342434243424300004400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4400007071707170717071707100004400505144444444447071627071444450514400005253525352535253525300004400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44000060614a4a4a4a4a4a606100004400404144464444446061626061444640414400004243444444444444424300004400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44000070714a4a4a4a4a4a707100004400505144444444467071007071444450514400005253444544444644525300004400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44000060614a4a4a4a4a4a606100004400404144454444444444444444444440410000004243444644444444424300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44000070714a4a4a4a4a4a707100004400505146444444464445444444444450510000005253444444454444525300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44000060614a4a4a4a4a4a606100004400404144444544444444444544454440410000004243444444444444424300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44000070714a4a4a4a4a4a707100004400505144444444444444444444444450510000005253444644444445525300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4400006061606160616061606100004400404144444544444544444644444540410000004243426566446743424300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4400007071707170717071707100004400505144444444444444444444444450510000005253527576447778525300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4400000000000000000000000000004400404144444644444444464444454440410000000000000044444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4400000000000000000000000000004400505144464444444444444445444450510000000000000044444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4400000000000000000000000000004400404140414041404140414041404140410000000000000044444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4444444444444444444444444444444400505150515051505150515051505150510000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
0110000018140181101a1401a1101c1401c1101d1401d1101f1401f1101d1401d1101c1401c1101f1401f1101c1401c1101d1401d1101a1401a1101a1401a1101c1401c1101d1401d1101f1401f1102314023110
0110000018140181101a1401a11018140181101c1401c110181401811017140171101a1401a1101c1401c1101a1401a1101c1401c1101a1401a1101c1401c1101a1401a11021140211101a1401a1101d1401d110
0110000018150181201a1501a12018150181201c1501c120181501812017150171201d1501d1201c1501c12018150181201a1501a1201c1501c1201a1501a1201d1501d1201c1501c1201a1501a1201d1501d120
0110000018140181101c1401c1101514015110151401511018140181101c1401c1101514015110151401511018140181101a1401a110171401711017140171101a1401a1101c1401c11015140151101514015110
01100000231402311018140181101a1401a1101c1401c1101d1401d1101f1401f1101d1401d1101c1401c1101f1401f1101c1401c1101d1401d1101a1401a1101a1401a1101c1401c1101d1401d1101f1401f110
011000001d1401d11018140181101a1401a11018140181101c1401c110181401811017140171101a1401a1101c1401c1101a1401a1101c1401c1101a1401a1101c1401c1101a1401a11021140211101a1401a110
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
011000002314023140231302313023120231222311223112211402114021130211302112021122211122111224140241402413024130241202412224112241121f1401f1401f1301f1301f1201f1221f1121f112
0110000026140261402613026130261202612226112261121f1401f1401f1321f132211202112021112211121d1401d1401d1321d132241202412024112241122314023140231302313023120231222311223112
011000002615026140261302613026120261222611226112241502414024132241222115021140211322112226150261402613026130261202612226112261122415024140241322412223150231402313223122
011000000075000750007500075000750007500075000750007500075000750007500075000750007500075000750007500075000750007500075000750007500475004750047500475004750047500475004750
011000000475004750047500475004750047500475004750047500475004750007500075000750007500075000750007500075000750007500075000750007500075000750007500075000750007500075000750
011000000475004750047500475004750047500475004750047500475004750047500475004750047500475004750047500475004750047500475004750047500075000750007500075000750007500075000750
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
011000002461500003000030000324615000030000300003246150000300003000032461500003000030000324615000030000300003246150000300003000032461500003000030000324615000030000300003
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
011000003055000500005000050000500005000050000500005000000000000000002f55000000000000000034550000000000000000000000000000000000003555000000000000000032550000000000000000
0110000030550000000000000000305500000000000000002d5500000000000000003455000000000000000034550000000000000000000000000000000000003255000000000000000030550000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
011000001c0701d07017070140701707014070180701b0701a070160701b0701707023070180701e07018070170701b0702107019070210701c0701b070180701e0701c070170701d0701f0701a0702007017070
__music__
01 000a1444
00 010b1445
00 020a141e
00 030c141f
02 040a141e
01 0d4a545e
02 0e4b545f
02 0f424344

